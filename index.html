<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SADEC Encrypted Email System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        .email-list-item.selected { background-color: #2d3748; border-left: 3px solid #0078d4; }
        .email-list-item.unread .font-bold { color: #f7fafc; }
        .delete-btn { opacity: 0; transition: opacity 0.2s ease-in-out; }
        .email-list-item:hover .delete-btn { opacity: 1; }
    </style>
</head>
<body class="bg-gray-900 h-screen">

    <!-- Loading / Processing Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="text-white mt-4">Processing login...</p>
        </div>
    </div>

    <!-- Login Overlay -->
    <div id="login-overlay" class="hidden fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="w-full max-w-sm p-8 rounded-lg shadow-xl bg-blue-600">
            <h2 class="text-2xl font-bold text-center text-white mb-2">San Andreas Department of Emergency Communications v3</h2>
            <p class="text-center text-gray-200 text-sm mb-6">Encrypted Email System</p>
            <div class="space-y-4">
                 <button id="discord-login-btn" class="w-full text-white font-semibold py-3 rounded-md shadow transition flex items-center justify-center space-x-3" style="background-color: #5865F2;" onmouseover="this.style.backgroundColor='#4a54d4'" onmouseout="this.style.backgroundColor='#5865F2'">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20.283 3.003s-.494-.14-1.252.192c-1.18.47-2.22,1.21-3.045,1.862-1.385-.43-2.88-.65-4.385-.65-1.506,0-2.998.22-4.384.65C6.39 5.245 5.35 4.505 4.17 4.033c-.808-.34-1.3-.22-1.3-.22s-.363.35-.62.82c-1.32,2.44-1.803,5.05-1.73,7.63.26,9.45,7.16,11.37,7.16,11.37s1.17-.5,2.06-1.22c-2.26-1.1-3.25-2.65-3.66-4.04H9.6c-.05,0-.1-.04-.1-.1s0-.1.1-.1h.1c.05,0,.1.04.1.1s0,.1-.1.1h3.36c-.49,1.58-1.79,2.94-3.66,4.04,1.03.8,2.06,1.22,2.06,1.22s6.9-1.92,7.16-11.37c.07-2.58-.41-5.19-1.73-7.63-.257-.47-.62-.82-.62-.82zM8.82,14.28c-.88,0-1.59-.72-1.59-1.6s.71-1.6,1.59-1.6c.88,0,1.59.72,1.59,1.6s-.71,1.6-1.59,1.6zm6.36,0c-.88,0-1.59-.72-1.59-1.6s.71-1.6,1.59-1.6c.88,0,1.59.72,1.59,1.6s-.71,1.6-1.59,1.6z"/></svg>
                    <span>Sign In With Discord</span>
                </button>
            </div>
             <p class="text-center text-gray-300 text-xs mt-6">This system is for authorized personnel only.</p>
        </div>
    </div>
    
    <!-- Create Account Overlay -->
    <div id="create-account-overlay" class="hidden fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="w-full max-w-md p-8 rounded-lg shadow-xl bg-blue-600">
            <h2 class="text-2xl font-bold text-center text-white mb-2">Welcome to SADEC, <span id="discord-username-display">User</span>!</h2>
            <p class="text-center text-gray-200 text-sm mb-6">Create your secure email address to continue.</p>
            <div class="space-y-4">
                <div class="flex items-center">
                    <input type="text" id="create-email-input" class="w-full p-3 border border-blue-500 bg-blue-500 text-white rounded-l-md focus:outline-none focus:ring-2 focus:ring-white placeholder-gray-300" placeholder="choose.a.username">
                    <span class="p-3 bg-blue-700 text-gray-200 rounded-r-md">@sadec.sa.gov</span>
                </div>
                <input type="hidden" id="reg-token-input">
                <button id="create-account-btn" class="w-full text-white font-semibold py-3 rounded-md shadow transition" style="background-color: #02133e;" onmouseover="this.style.backgroundColor='#031a54'" onmouseout="this.style.backgroundColor='#02133e'">Create Account and Sign In</button>
                <p id="create-error" class="text-yellow-300 text-center text-sm h-4"></p>
            </div>
        </div>
    </div>

    <!-- Main Application (Populated by JS) -->
    <div id="main-app" class="w-full h-full bg-gray-800 text-gray-200 flex-col hidden"></div>

    <!-- Modals (Populated by JS) -->
    <div id="compose-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"></div>
    <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"></div>
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"></div>

    <script>
    // --- STEP 3: PASTE YOUR WEB APP URL HERE ---
    const googleSheetWebAppUrl = 'https://script.google.com/macros/s/AKfycbxkGRXtJiCsLk0qc2V80D6MPHupDbwr0xY5gU9fyk_RfKPuc90YWWBYcPKAR6g0hYBC/exec';
    
    // --- DO NOT EDIT BELOW THIS LINE ---
    
    // --- DOM ELEMENTS ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const loginOverlay = document.getElementById('login-overlay');
    const createAccountOverlay = document.getElementById('create-account-overlay');
    const mainApp = document.getElementById('main-app');
    
    // --- AUTHENTICATION & PAGE LOAD ---
    
    function loginWithDiscord() {
        // Redirect the whole page to the login endpoint of the script
        window.location.href = `${googleSheetWebAppUrl}?action=login`;
    }

    function logout() {
        localStorage.removeItem('sadecUserEmail');
        location.href = location.pathname; // Reload page without params
    }

    async function handlePageLoad() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const regToken = urlParams.get('regToken');
        const discordUsername = urlParams.get('discordUsername');

        // Clean the URL to remove the tokens
        if (token || regToken) {
            history.replaceState(null, '', window.location.pathname);
        }

        if (token) {
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');
            await exchangeTokenForEmail(token);
        } else if (regToken) {
            showRegistrationScreen(regToken, discordUsername);
        } else {
            const userEmail = localStorage.getItem('sadecUserEmail');
            if (userEmail) {
                showMainApp(userEmail);
            } else {
                loginOverlay.classList.remove('hidden');
                loginOverlay.classList.add('flex');
            }
        }
    }

    async function exchangeTokenForEmail(token) {
        try {
            const response = await fetch(googleSheetWebAppUrl, {
                method: 'POST',
                mode: 'cors', // Required for cross-origin requests
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'exchangeToken', token: token })
            });
            const data = await response.json();
            if (data.status === 'success' && data.email) {
                localStorage.setItem('sadecUserEmail', data.email);
                showMainApp(data.email);
            } else {
                alert(`Login failed: ${data.message}`);
                showLoginScreen();
            }
        } catch (error) {
            console.error("Token exchange error:", error);
            alert('An error occurred during login. Please try again.');
            showLoginScreen();
        }
    }

    function showRegistrationScreen(regToken, discordUsername) {
        createAccountOverlay.classList.remove('hidden');
        createAccountOverlay.classList.add('flex');
        document.getElementById('reg-token-input').value = regToken;
        document.getElementById('discord-username-display').textContent = discordUsername || 'User';
        document.getElementById('create-email-input').focus();
    }
    
    async function createAccount() {
        const createBtn = document.getElementById('create-account-btn');
        const createError = document.getElementById('create-error');
        const chosenUsername = document.getElementById('create-email-input').value.trim();
        const regToken = document.getElementById('reg-token-input').value;

        if (!chosenUsername) {
            createError.textContent = "Please enter a desired username.";
            return;
        }

        createBtn.disabled = true;
        createBtn.textContent = 'Creating...';
        createError.textContent = '';

        try {
            const response = await fetch(googleSheetWebAppUrl, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'createSadecEmail', regToken, chosenUsername })
            });
            const data = await response.json();

            if (data.status === 'success' && data.token) {
                // Account created, now log in with the final token
                await exchangeTokenForEmail(data.token);
            } else {
                createError.textContent = data.message || "An unknown error occurred.";
            }
        } catch (error) {
            createError.textContent = "Could not contact server. Please try again later.";
        } finally {
            createBtn.disabled = false;
            createBtn.textContent = 'Create Account and Sign In';
        }
    }

    function showMainApp(userEmail) {
        loadingOverlay.classList.add('hidden');
        loginOverlay.classList.add('hidden');
        createAccountOverlay.classList.add('hidden');
        mainApp.classList.remove('hidden');
        mainApp.classList.add('flex');
        renderFullAppUI(userEmail);
        fetchMessages();
    }

    function showLoginScreen() {
        loadingOverlay.classList.add('hidden');
        createAccountOverlay.classList.add('hidden');
        mainApp.classList.add('hidden');
        loginOverlay.classList.remove('hidden');
        loginOverlay.classList.add('flex');
    }

    // --- UI RENDERING & APP LOGIC (These functions need to be fully implemented) ---
    function renderFullAppUI(userEmail) { /* ... Paste full function from previous steps ... */ }
    function addAppEventListeners() { /* ... Paste full function from previous steps ... */ }
    // ... all other app functions ...

    // --- EVENT LISTENERS ---
    document.getElementById('discord-login-btn').addEventListener('click', loginWithDiscord);
    document.getElementById('create-account-btn').addEventListener('click', createAccount);
    
    // --- INITIALIZATION ---
    handlePageLoad();
    </script>
</body>
</html>
